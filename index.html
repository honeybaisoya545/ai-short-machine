<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Shorts Machine</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: white;
      text-align: center;
      padding: 50px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    input {
      padding: 10px;
      width: 70%;
      border-radius: 8px;
      border: none;
      margin: 10px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #1e293b;
      margin: 5px auto;
      padding: 10px;
      border-radius: 8px;
      max-width: 600px;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .channel-info {
      flex-grow: 1;
    }
    .remove-btn {
      background: #ef4444;
      padding: 5px 10px;
      font-size: 14px;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ AI Shorts Machine</h1>
    <p>Add any video link. AI will make shorts automatically.</p>
    
    <input type="text" id="channelLink" placeholder="Paste YouTube, Facebook, TikTok link"/>
    <button onclick="addChannel()">Add Channel</button>

    <button onclick="toggleMachine()">AI Machine: OFF</button>
    <button onclick="testWithSampleVideo()">Test Sample Video</button>

    <h2>Your Channels</h2>
    <ul id="channelList"></ul>
  </div>

  <script>
    // Store added channels in an array
    let addedChannels = [];

    function addChannel() {
      const link = document.getElementById("channelLink").value.trim();
      if (!link) return alert("Please enter a link");

      // Basic check to avoid duplicates (simple check)
      if (addedChannels.some(c => c.url === link)) {
          alert("This channel is already added.");
          return;
      }

      let platform = "Other";
      let icon = "üåê";
      let channelId = null; // We'll try to extract this for YouTube

      if (link.includes("youtube.com") || link.includes("youtu.be")) {
        platform = "YouTube";
        icon = "üì∫";
        // Try to extract channel ID from common YouTube URL formats
        // This is a simplified version, might not work for all edge cases
        try {
            const url = new URL(link);
            if (url.pathname.startsWith('/channel/')) {
                channelId = url.pathname.split('/')[2];
            } else if (url.pathname.startsWith('/c/')) {
                // Custom URL like youtube.com/c/ChannelName - harder to get ID directly
                // For now, we'll store the URL and note we need the ID
                // A full implementation would require an API call to resolve the custom URL
                // For simplicity, we'll assume the user provides a direct channel URL
                 alert("Please provide a direct channel URL like https://www.youtube.com/channel/UC... for full functionality.");
            } else if (url.pathname.startsWith('/@')) {
                 alert("Please provide a direct channel URL like https://www.youtube.com/channel/UC... for full functionality.");
            } else if (url.searchParams.has('channel')) {
                 channelId = url.searchParams.get('channel');
            }
        } catch (e) {
            console.error("Error parsing URL:", e);
        }
        if (!channelId) {
             alert("Could not automatically extract Channel ID. Please ensure the link is a direct channel link (e.g., https://www.youtube.com/channel/UC...).");
             return; // Don't add if we can't get the ID for YouTube
        }

      } else if (link.includes("facebook.com")) {
        platform = "Facebook";
        icon = "üìò";
        // Facebook ID extraction is complex, might need API or scraping
        // For now, we store the link but note limitations
         alert("Facebook channel checking might not work fully with just the link. Feature is limited.");
      } else if (link.includes("tiktok.com")) {
        platform = "TikTok";
        icon = "üéµ";
        // TikTok ID extraction is also complex
         alert("TikTok channel checking might not work fully with just the link. Feature is limited.");
      } else {
          alert("Unsupported platform or link format.");
          return;
      }

      const channelData = {
        url: link,
        platform: platform,
        icon: icon,
        id: channelId // Will be null for non-YouTube or if extraction failed
      };

      addedChannels.push(channelData);

      const list = document.getElementById("channelList");
      const li = document.createElement("li");
      li.dataset.index = addedChannels.length - 1; // Store index for removal
      li.innerHTML = `
        <span class="channel-info"><strong>${icon} ${platform}</strong>: ${link.substring(0, 40)}${link.length > 40 ? '...' : ''}</span>
        <button class="remove-btn" onclick="removeChannel(${addedChannels.length - 1})">Remove</button>
      `;
      list.appendChild(li);
      document.getElementById("channelLink").value = "";
    }

    function removeChannel(index) {
        if (index >= 0 && index < addedChannels.length) {
            addedChannels.splice(index, 1);
            // Re-render the list to keep indices correct
            renderChannelList();
        }
    }

    function renderChannelList() {
        const list = document.getElementById("channelList");
        list.innerHTML = ""; // Clear list
        addedChannels.forEach((channel, index) => {
             const li = document.createElement("li");
             li.dataset.index = index;
             li.innerHTML = `
               <span class="channel-info"><strong>${channel.icon} ${channel.platform}</strong>: ${channel.url.substring(0, 40)}${channel.url.length > 40 ? '...' : ''}</span>
               <button class="remove-btn" onclick="removeChannel(${index})">Remove</button>
             `;
             list.appendChild(li);
        });
    }

    // YouTube API Integration
    let isMachineOn = false;
    let youtubeApiKey = "AIzaSyCi1owTgpghGwR6a4sztcYNFXZg7EDNjos"; // Your real API key

    function toggleMachine() {
      isMachineOn = !isMachineOn;
      const button = document.querySelector('button[onclick="toggleMachine()"]');
      
      if (isMachineOn) {
        button.textContent = "AI Machine: ON";
        button.style.background = "#10b981";
        startCheckingVideos(); // This will now check YOUR channels
      } else {
        button.textContent = "AI Machine: OFF";
        button.style.background = "#10b981";
      }
    }

    function startCheckingVideos() {
      if (!isMachineOn) return;
      
      if (addedChannels.length === 0) {
          alert("ü§ñ AI Machine is ON, but you haven't added any channels yet.");
          return;
      }

      alert("ü§ñ AI Machine is now checking for new videos in your added channels...");
      
      // Loop through added channels and check YouTube ones
      let foundYouTubeChannel = false;
      for (const channel of addedChannels) {
          if (channel.platform === "YouTube" && channel.id) {
              foundYouTubeChannel = true;
              checkNewVideo(channel.id); // Check each added YouTube channel
          }
      }

      if (!foundYouTubeChannel) {
          alert("No valid YouTube channels found to check. Please add YouTube channels with direct /channel/ URLs.");
      }
    }

    // Smart Clip Processing Logic - Step 5.1
    function calculateShortsFromVideo(totalDuration, targetDuration = 65) {
      const fullClips = Math.floor(totalDuration / targetDuration);
      const leftoverTime = totalDuration % targetDuration;
      
      let finalClips = fullClips;
      let lastClipDuration = targetDuration;
      
      if (leftoverTime > 10) {
        if (fullClips > 0) {
          const extraTimePerClip = Math.min(5, Math.floor(leftoverTime / Math.min(3, fullClips)));
          lastClipDuration = targetDuration + (leftoverTime - (extraTimePerClip * (fullClips - 1)));
        } else {
          lastClipDuration = leftoverTime;
        }
      }
      
      return {
        totalShorts: fullClips > 0 ? fullClips : 1,
        lastClipDuration: lastClipDuration,
        leftoverTime: leftoverTime
      };
    }

    // Helper function to convert ISO 8601 duration to seconds
    function parseISO8601Duration(duration) {
      const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      const hours = parseInt(match[1]) || 0;
      const minutes = parseInt(match[2]) || 0;
      const seconds = parseInt(match[3]) || 0;
      return hours * 3600 + minutes * 60 + seconds;
    }

    // Test function with a known video (10 minutes)
    function testWithSampleVideo() {
      const sampleDuration = 600; // 10 minutes = 600 seconds
      const result = calculateShortsFromVideo(sampleDuration);
      
      alert(`üß™ Sample Video Test:
Duration: 10:00 (600 seconds)
Target Short: 65 seconds
Full Shorts: ${result.totalShorts}
Last Short: ${result.lastClipDuration} seconds
Leftover: ${result.leftoverTime} seconds`);
    }

    // Enhanced Video Detection - Step 5.2 (Updated with cache bypass and channel ID)
    async function checkNewVideo(channelId) {
      try {
        // Add a random timestamp to bypass cache
        const timestamp = Date.now();

        // Get 3 most recent videos instead of just 1
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/search?order=date&part=snippet,id&channelId=${channelId}&maxResults=3&key=${youtubeApiKey}&timestamp=${timestamp}`
        );
        const data = await response.json();

        // Check for API errors first
        if (data.error) {
            console.error("YouTube API Error:", data.error);
            alert(`YouTube API Error for channel ${channelId}: ${data.error.message}`);
            return;
        }
        
        if (data.items && data.items.length > 0) {
          let message = `üÜï Recent videos detected for channel ID ${channelId}:\n\n`;
          
          // Check first 3 videos
          for(let i = 0; i < Math.min(3, data.items.length); i++) {
            const video = data.items[i];
            const videoId = video.id.videoId;
            const title = video.snippet.title;
            
            // Get video duration
            const durationResponse = await fetch(
              `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&part=contentDetails&key=${youtubeApiKey}&timestamp=${timestamp}`
            );
            const durationData = await durationResponse.json();

             // Check for API errors in duration call
            if (durationData.error) {
                console.error("YouTube API Error (Duration):", durationData.error);
                message += `${i+1}. ${title} (Duration: Error fetching)\n\n`;
                continue; // Skip this video if duration fetch fails
            }
            
            if (durationData.items && durationData.items.length > 0) {
              const durationISO = durationData.items[0].contentDetails.duration;
              const durationSeconds = parseISO8601Duration(durationISO);
              
              const clipInfo = calculateShortsFromVideo(durationSeconds);
              
              // Ask user if they want to process this video
              const userChoice = confirm(`üÜï New video detected!
Title: ${title}
Duration: ${Math.floor(durationSeconds/60)}:${String(durationSeconds%60).padStart(2,'0')}
Shorts Possible: ${clipInfo.totalShorts}

Click OK to process this video into shorts, Cancel to skip.`);

              if (userChoice) {
                processVideoCompletely(videoId, title);
                return; // Process only the first selected video for now, then stop checking this channel
              }

              message += `${i+1}. ${title}
Duration: ${Math.floor(durationSeconds/60)}:${String(durationSeconds%60).padStart(2,'0')}
Shorts: ${clipInfo.totalShorts} clips (${clipInfo.lastClipDuration}s last)
\n`;
            } else {
              message += `${i+1}. ${title} (Duration: N/A)\n\n`;
            }
          }
          
          // Only show list if no video was selected for processing
          if (!message.includes("processVideoCompletely")) {
             alert(message);
          }
        } else {
          // It's okay if one channel has no videos, don't alert for every one
          console.log(`No recent videos found for channel ID: ${channelId}`);
          // alert(`No recent videos found for channel ID: ${channelId}`); // Optional: less intrusive
        }
      } catch (error) {
        console.error("Error checking for videos for channel", channelId, ":", error);
        alert(`Error checking for videos for channel ${channelId}. Check console for details.`);
      }
    }


    // Step 6: Video Processing Functions

    // Function to simulate video processing (since we can't do real processing in browser)
    function processVideoToShorts(videoId, duration, numberOfShorts) {
      alert(`üé¨ Starting video processing...
      
Video ID: ${videoId}
Duration: ${duration} seconds
Shorts to create: ${numberOfShorts}

‚ö†Ô∏è Note: Real video processing requires backend/server.
This is a simulation for now.`);

      // Simulate processing time
      setTimeout(() => {
        alert(`‚úÖ Video processing complete!
        
Created ${numberOfShorts} shorts from video.
Each short is 65 seconds long (9:16 ratio).
Added automatic captions and basic effects.`);
      }, 3000);
    }

    // Function to generate video editing links
    function getVideoEditingLinks(videoId) {
      const links = {
        "Online Video Cutter": `https://online-video-cutter.com/?url=https://youtube.com/watch?v=${videoId}`,
        "Clideo": `https://clideo.com/cut-video?url=https://youtube.com/watch?v=${videoId}`,
        "VidLouder": `https://www.vidlouder.com/video-editor/?url=https://youtube.com/watch?v=${videoId}`
      };
      
      let message = "üîß Video Editing Tools:\n\n";
      for (const [name, url] of Object.entries(links)) {
        message += `${name}: ${url}\n\n`;
      }
      
      return message;
    }

    // Enhanced function to process a video completely
    async function processVideoCompletely(videoId, title) {
      try {
        // Add a random timestamp to bypass cache
        const timestamp = Date.now();

        // Get video duration
        const durationResponse = await fetch(
          `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&part=contentDetails&key=${youtubeApiKey}&timestamp=${timestamp}`
        );
        const durationData = await durationResponse.json();

        // Check for API errors in duration call
        if (durationData.error) {
            console.error("YouTube API Error (Processing Duration):", durationData.error);
            alert(`Error fetching video duration: ${durationData.error.message}`);
            return;
        }
        
        if (durationData.items && durationData.items.length > 0) {
          const durationISO = durationData.items[0].contentDetails.duration;
          const durationSeconds = parseISO8601Duration(durationISO);
          
          const clipInfo = calculateShortsFromVideo(durationSeconds);
          
          const result = `üìπ Video Processing Ready:
Title: ${title}
Duration: ${Math.floor(durationSeconds/60)}:${String(durationSeconds%60).padStart(2,'0')}
Shorts: ${clipInfo.totalShorts} clips
Last Clip: ${clipInfo.lastClipDuration} seconds

Choose an option:
1. Simulate Processing (Demo)
2. Get Editing Tool Links
3. Cancel`;

          const choice = confirm(result + "\n\nClick OK for Demo, Cancel for Editing Links");
          
          if (choice) {
            // Simulate processing
            processVideoToShorts(videoId, durationSeconds, clipInfo.totalShorts);
          } else {
            // Show editing tool links
            const links = getVideoEditingLinks(videoId);
            alert(links);
          }
        } else {
             alert("Could not retrieve video details for processing.");
        }
      } catch (error) {
        console.error("Error processing video:", error);
        alert("Error processing video. Check console for details.");
      }
    }
  </script>
</body>
</html>
